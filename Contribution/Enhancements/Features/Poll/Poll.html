<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Live Poll — Editable (Firebase RTDB)</title>

  <!-- Optional Reveal.js styles (page works without Reveal, too) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.6.2/reveal.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.6.2/theme/black.min.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>

  <style>
    :root { --fg:#fff; --muted:#aaa; --border:#444; --bg:#000; }
    body{ background:var(--bg); color:var(--fg); }
    .poll{ display:grid; gap:12px; }
    .poll-card{ border:1px solid var(--border); border-radius:12px; padding:14px; background:#0b0b0b; }
    .poll-controls{ display:flex; flex-wrap:wrap; gap:10px; }
    button{ padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#171717; color:var(--fg); cursor:pointer; }
    button[disabled]{ opacity:.55; cursor:not-allowed; }
    input[type="text"], input[type="number"]{ padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:#111; color:var(--fg); width:100%; }
    label{ font-size:.95rem; color:var(--muted); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .col{ display:flex; flex-direction:column; gap:6px; width:100%; } /* full width rows */
    .grid{ display:grid; gap:10px; }
    .grid-1{ grid-template-columns: 1fr; } /* single column: one item per line */
    .sr-only{ position:absolute; left:-10000px; width:1px; height:1px; overflow:hidden; }
    canvas{ width:100%; height:300px; display:block; }
    .muted{ color:var(--muted); }
    .divider{ height:1px; background:var(--border); margin:10px 0; }
    .spacer{ flex:1 1 auto; }
  </style>
</head>
<body>
  <div class="reveal">
    <div class="slides">
      <section>
        <h2>Live Poll</h2>
        <p class="muted">Edit the question & options in <code>host</code> mode. Share the <code>voter</code> link with your audience.</p>

        <div class="poll">
          <!-- Host-only: Edit Panel (hidden until Edit is toggled) -->
          <div id="editPanel" class="poll-card" style="display:none;">
            <!-- Question (full line) -->
            <div class="col">
              <label>Poll Question</label>
              <input id="qInput" type="text" placeholder="Type your question…" maxlength="200" />
            </div>

            <!-- Number of options (full line) -->
            <div class="col">
              <label>Number of options (2–8)</label>
              <input id="nInput" type="number" min="2" max="8" step="1" value="4" />
            </div>

            <div class="divider"></div>

            <!-- Options (one per line) -->
            <div id="optionsGrid" class="grid grid-1">
              <!-- Option inputs injected here, one per row -->
            </div>

            <div class="row" style="justify-content:flex-end;">
              <button id="saveConfig">Save Config</button>
            </div>
            <p id="editNote" class="muted" style="margin:8px 0 0;"></p>
          </div>

          <!-- Poll UI -->
          <div class="poll-card">
            <div class="row" style="align-items:flex-end;">
              <div>
                <strong id="questionText">Which option do you prefer?</strong><br/>
                <span class="muted">Links → Host: <code>?mode=host&poll=YOUR-ID</code> • Voter: <code>?mode=voter&poll=YOUR-ID</code></span>
              </div>
              <div class="spacer"></div>
              <div class="row">
                <button id="toggleEdit" style="display:none;">Edit</button>
                <button id="resetPoll" title="UI reset (use new ?poll= for backend-fresh round)">Reset</button>
                <button id="exportResults">Export Results</button>
              </div>
            </div>

            <div id="buttonsWrap" class="poll-controls" style="margin-top:10px;">
              <!-- Vote buttons injected here -->
            </div>

            <div id="hostChartCard" class="poll-card" style="margin-top:12px;">
              <canvas id="pollChart" aria-label="Bar chart of poll results" role="img"></canvas>
            </div>

            <p id="liveRegion" class="sr-only" aria-live="polite" aria-atomic="true"></p>
            <p id="totals" class="muted" style="margin-top:8px;"></p>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Firebase SDKs at the end so DOM is ready -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCWyWepJTNv3MvRvfuVeTr063O6fug-urQ",
      authDomain: "webtechnologiespollfeature.firebaseapp.com",
      databaseURL: "https://webtechnologiespollfeature-default-rtdb.firebaseio.com",
      projectId: "webtechnologiespollfeature",
      storageBucket: "webtechnologiespollfeature.firebasestorage.app",
      messagingSenderId: "354217528493",
      appId: "1:354217528493:web:8a0b0fe25c88c8f7d90a24",
      measurementId: "G-4KHLCRBCKN"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // URL params
    const qp = (k) => new URL(location.href).searchParams.get(k);
    const role  = (qp('mode') || 'host').toLowerCase();   // 'host' or 'voter'
    const pollId = (qp('poll') || 'demo-abc').trim();

    // DOM refs
    const editPanel  = document.getElementById('editPanel');
    const qInput     = document.getElementById('qInput');
    const nInput     = document.getElementById('nInput');
    const optionsGrid= document.getElementById('optionsGrid');
    const saveBtn    = document.getElementById('saveConfig');
    const editNote   = document.getElementById('editNote');

    const questionText = document.getElementById('questionText');
    const buttonsWrap  = document.getElementById('buttonsWrap');
    const chartCard    = document.getElementById('hostChartCard');
    const resetBtn     = document.getElementById('resetPoll');
    const exportBtn    = document.getElementById('exportResults');
    const totalsEl     = document.getElementById('totals');
    const liveEl       = document.getElementById('liveRegion');
    const toggleEditBtn= document.getElementById('toggleEdit');

    // Admin state
    let adminUid = null;
    let isAdmin  = false;

    // Chart state
    let options = ["Alpha","Beta","Gamma","Delta"];  // default if no config yet
    let counts = [];
    let chart  = null;

    // Helpers
    const alphaLabel = (i) => String.fromCharCode(65 + i); // 0->A, 1->B ...
    const clamp      = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

    function rebuildChart() {
      counts = new Array(options.length).fill(0);
      const ctx = document.getElementById('pollChart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: { labels: options.map((_,i)=>alphaLabel(i)), datasets: [{ data: counts }] },
        options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }, plugins:{ legend:{ display:false } } }
      });
      updateUI();
    }

    function updateUI() {
      chart.data.labels = options.map((_,i)=>alphaLabel(i));
      chart.data.datasets[0].data = counts;
      chart.update();
      const t = counts.reduce((a,b)=>a+b,0);
      const pct = (v) => t ? `${Math.round((v/t)*100)}%` : '0%';
      const parts = counts.map((v,i)=> `${alphaLabel(i)} ${v} (${pct(v)})`);
      totalsEl.textContent = `Total: ${t} — ${parts.join(', ')}`;
    }

    function renderButtons(uid) {
      buttonsWrap.innerHTML = '';
      options.forEach((text, i) => {
        const btn = document.createElement('button');
        btn.textContent = `${alphaLabel(i)} — ${text}`;
        btn.dataset.choice = String(i);
        btn.addEventListener('click', () => voterVote(uid, i));
        buttonsWrap.appendChild(btn);
      });
    }

    // Options inputs: one per line
    function renderOptionInputs() {
      const n = clamp(Number(nInput.value || 4), 2, 8);
      optionsGrid.innerHTML = '';
      for (let i=0; i<n; i++) {
        const wrap = document.createElement('div');
        wrap.className = 'col';               // full width row
        const lab = document.createElement('label');
        lab.textContent = `Option ${alphaLabel(i)}`;
        const inp = document.createElement('input');
        inp.type = 'text'; inp.maxLength = 60;
        inp.value = options[i] || `Option ${alphaLabel(i)}`;
        inp.id = `opt-${i}`;
        inp.disabled = !isAdmin;
        wrap.appendChild(lab);
        wrap.appendChild(inp);
        optionsGrid.appendChild(wrap);
      }
      qInput.disabled = !isAdmin;
      nInput.disabled = !isAdmin;
      saveBtn.disabled = !isAdmin;
      editNote.textContent = isAdmin
        ? 'You are the admin for this poll.'
        : 'View-only: only the admin can save changes.';
    }

    async function saveConfig(uid) {
      // First writer of adminUid becomes admin
      if (!adminUid) {
        await set(ref(db, `polls/${pollId}/adminUid`), uid).catch(()=>{});
      }
      const n = clamp(Number(nInput.value || 4), 2, 8);
      const newOpts = [];
      for (let i=0; i<n; i++) {
        const v = (document.getElementById(`opt-${i}`)?.value || '').trim();
        newOpts.push(v || `Option ${alphaLabel(i)}`);
      }
      const q = (qInput.value || 'Which option do you prefer?').trim();
      await set(ref(db, `polls/${pollId}/config`), { question: q, options: newOpts })
        .then(()=> editNote.textContent = 'Config saved.')
        .catch(e => editNote.textContent = `Save failed: ${e?.message || e}`);
    }

    function applyConfig(cfg) {
      const q = (cfg?.question || 'Which option do you prefer?');
      const arr = Array.isArray(cfg?.options) && cfg.options.length >= 2
        ? cfg.options.slice(0,8)
        : options;
      options = arr;
      questionText.textContent = q;
      rebuildChart();
    }

    function subscribeToConfigAndVotes(uid) {
      // Config
      onValue(ref(db, `polls/${pollId}/config`), (snap) => {
        const cfg = snap.val();
        applyConfig(cfg);

        // Buttons by role
        if (role === 'voter') {
          renderButtons(uid);
          chartCard.style.display = 'none';
          resetBtn.style.display = 'none';
          exportBtn.style.display = 'none';
          toggleEditBtn.style.display = 'none';
        } else {
          renderButtons(uid); // host can also vote if desired
        }
      });

      // Votes
      onValue(ref(db, `polls/${pollId}/votes`), (snap) => {
        const data = snap.val() || {};
        counts = new Array(options.length).fill(0);
        Object.values(data).forEach(v => {
          const idx = Number(v?.choice);
          if (Number.isInteger(idx) && idx >= 0 && idx < options.length) counts[idx]++;
        });
        updateUI();
        liveEl.textContent = 'Poll updated.';
      });
    }

    async function voterVote(uid, idx) {
      const myRef = ref(db, `polls/${pollId}/votes/${uid}`);
      await set(myRef, { choice: idx, ts: new Date().toISOString() })
        .then(() => {
          [...buttonsWrap.querySelectorAll('button')].forEach(b => b.disabled = true);
          liveEl.textContent = 'Vote submitted.';
        })
        .catch(e => console.warn('Vote failed:', e));
    }

    // Toggle edit mode button
    function wireToggleEdit(uid) {
      if (role !== 'host') return;
      toggleEditBtn.style.display = 'inline-block';
      toggleEditBtn.addEventListener('click', () => {
        const open = editPanel.style.display !== 'none';
        editPanel.style.display = open ? 'none' : 'block';
      });
    }

    async function hydrateAdmin(uid) {
      const snap = await get(ref(db, `polls/${pollId}/adminUid`));
      adminUid = snap.exists() ? snap.val() : null;
      isAdmin  = !adminUid || adminUid === uid; // first host or the stored admin
    }

    async function wireEditPanel(uid) {
      if (role !== 'host') { editPanel.style.display = 'none'; return; }
      await hydrateAdmin(uid);

      // hydrate inputs from current config
      const cfgSnap = await get(ref(db, `polls/${pollId}/config`));
      const cfg = cfgSnap.val() || { question: 'Which option do you prefer?', options };
      qInput.value = cfg.question || 'Which option do you prefer?';
      nInput.value = Array.isArray(cfg.options) ? clamp(cfg.options.length, 2, 8) : 4;
      options = Array.isArray(cfg.options) && cfg.options.length ? cfg.options : options;

      renderOptionInputs();
      nInput.addEventListener('change', renderOptionInputs);
      saveBtn.addEventListener('click', () => {
        if (!isAdmin) { editNote.textContent = 'Only the admin can save.'; return; }
        saveConfig(uid);
      });
    }

    function doResetUI() {
      counts = new Array(options.length).fill(0);
      rebuildChart();
      [...buttonsWrap.querySelectorAll('button')].forEach(b => b.disabled = false);
      liveEl.textContent = 'Poll cleared (use new ?poll= for a backend-fresh round).';
    }
    resetBtn.addEventListener('click', doResetUI);

    exportBtn.addEventListener('click', () => {
      const payload = {
        pollId,
        exportedAt: new Date().toISOString(),
        question: questionText.textContent,
        options,
        counts,
        total: counts.reduce((a,b)=>a+b,0)
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `poll-${pollId}-export.json`; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
      liveEl.textContent = 'Exported current tallies.';
    });

    // Start
    signInAnonymously(auth);
    onAuthStateChanged(auth, async (user) => {
      if (!user) return;
      const uid = user.uid;

      wireToggleEdit(uid);         // show the Edit button for host
      await wireEditPanel(uid);    // prepare edit panel (enable/disable based on admin)
      subscribeToConfigAndVotes(uid);
    });
  </script>
</body>
</html>
